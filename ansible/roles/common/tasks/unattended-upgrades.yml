---
- name: Update the apt package index
  ansible.builtin.apt:
    update_cache: true
    cache_valid_time: 3600 # Update cache if older than 1 hour

- name: Install unattended-upgrades package
  ansible.builtin.apt:
    name: unattended-upgrades
    state: present

- name: Enable unattended-upgrades
  ansible.builtin.command: dpkg-reconfigure -f noninteractive unattended-upgrades
  register: my_output
  changed_when: my_output.rc != 0

- name: Copy unattended-upgrades configuration file
  ansible.builtin.copy:
    src: 50unattended-upgrades
    dest: /etc/apt/apt.conf.d/50unattended-upgrades
    owner: root
    group: root
    mode: "0644"

- name: Copy 20auto-upgrades file
  ansible.builtin.copy:
    src: 20auto-upgrades
    dest: /etc/apt/apt.conf.d/20auto-upgrades
    owner: root
    group: root
    mode: "0644"

- name: Ensure the /etc/update-motd.d directory exists
  ansible.builtin.file:
    path: /etc/update-motd.d
    state: directory
    mode: "0755"

- name: Copy update-motd-unattended-upgrades file
  ansible.builtin.copy:
    src: update-motd-unattended-upgrades
    dest: /etc/update-motd.d/update-motd-unattended-upgrades
    owner: root
    group: root
    mode: "0755"

- name: Ensure unattended-upgrades service is running
  ansible.builtin.systemd:
    name: unattended-upgrades
    state: started
    enabled: true
